# PyImport2Pkg v0.2.0 更新日志

**发布日期**: 2025-12-05

## 概述

v0.2.0 版本是一次重要的功能增强更新，主要改进了可选依赖处理、Python 版本自动检测、错误报告机制以及映射数据覆盖范围。

---

## 新功能

### 1. 可选依赖默认包含

**变更**: 将 `--include-optional` 参数改为 `--exclude-optional`

- **之前**: 默认不包含可选包，需要 `--include-optional` 手动开启
- **现在**: 默认包含可选包，使用 `--exclude-optional` 排除

**原因**: 可选依赖（try-except、平台判断等）实际上是项目功能的一部分，默认包含更符合生成完整依赖列表的需求。

### 2. Python 版本自动检测

新增 `detect_python_version()` 函数，按以下优先级自动检测目标 Python 版本：

1. `.python-version` 文件（pyenv）
2. `pyproject.toml` 的 `requires-python` 字段
3. `setup.cfg` 的 `python_requires` 字段
4. `.venv/pyvenv.cfg` 虚拟环境配置

```python
from pyimport2pkg.filter import detect_python_version

version = detect_python_version(project_root)
# 返回 (3, 8) 或 None
```

### 3. 增强的输出格式

#### requirements.txt 分段输出

```text
# Auto-generated by pyimport2pkg
# Generated at: 2025-12-05T10:30:00

# === Required packages ===
numpy
pandas
requests

# === Conditional imports (if块内，平台/环境相关) ===
pywin32  # conditional in utils.py:15

# === Try-except imports (可选依赖，有替代方案) ===
ujson  # try_except in main.py:8

# === Packages with multiple candidates ===
# cv2 -> opencv-python (10.5M downloads)
#   alternatives: opencv-contrib-python (2.1M), opencv-python-headless (1.8M)

# === Errors (需要手动检查) ===
# [Syntax Error] broken.py:10 - invalid syntax
# [Dynamic Import] utils.py:25 - Dynamic import with non-literal argument
```

#### 下载量显示

多候选包现在显示格式化的下载量：
- `10.5M` - 千万级
- `500.0K` - 十万级
- `999` - 小于1000直接显示

### 4. 错误报告增强

在输出中新增 Errors section，报告：
- 语法错误文件
- 读取失败文件
- 无法解析的动态导入

### 5. 数据库构建错误日志

`build-db` 命令现在：
- 记录失败包的详细信息
- 生成 `build_errors.json` 错误日志
- 显示错误类型统计

```bash
$ pyimport2pkg build-db

Database built successfully!
  Total packages: 5000
  Successful: 4850
  Failed: 150

Error breakdown:
  - timeout: 80
  - not_found: 45
  - http_error: 25

Detailed error log: ~/.pyimport2pkg/data/build_errors.json
```

---

## 映射数据扩充

### 硬编码映射新增 (~80个)

#### NLP/文本处理
- `spacy` → spacy
- `nltk` → nltk
- `gensim` → gensim
- `jieba` → jieba

#### 任务调度
- `apscheduler` → APScheduler
- `celery` → celery
- `rq` → rq
- `schedule` → schedule

#### 日志
- `loguru` → loguru
- `structlog` → structlog

#### 数据库
- `pymongo` → pymongo
- `redis` → redis
- `elasticsearch` → elasticsearch
- `neo4j` → neo4j
- `cassandra` → cassandra-driver

#### Web 爬虫
- `scrapy` → Scrapy
- `selenium` → selenium
- `playwright` → playwright
- `pyppeteer` → pyppeteer

#### 消息队列
- `kafka` → kafka-python
- `pika` → pika
- `nats` → nats-py

#### 其他常用
- `hydra` → hydra-core
- `omegaconf` → omegaconf
- `sentry_sdk` → sentry-sdk
- `stripe` → stripe
- `twilio` → twilio

### 命名空间映射新增 (~30个)

#### Apache Airflow Providers
```python
airflow.providers.amazon → apache-airflow-providers-amazon
airflow.providers.google → apache-airflow-providers-google
airflow.providers.postgres → apache-airflow-providers-postgres
# ... 更多 providers
```

#### Databricks
```python
databricks.sdk → databricks-sdk
databricks.connect → databricks-connect
```

#### Snowflake
```python
snowflake.connector → snowflake-connector-python
snowflake.snowpark → snowflake-snowpark-python
```

#### TensorFlow/PyTorch 扩展
```python
tensorflow.keras → tensorflow
torch.nn → torch
torchvision → torchvision
```

### Backports 数据补充

| 模块 | 最低版本 | backport 包 |
|------|----------|-------------|
| dataclasses | 3.7 | dataclasses |
| importlib.metadata | 3.8 | importlib-metadata |
| importlib.resources | 3.9 | importlib-resources |
| zoneinfo | 3.9 | backports.zoneinfo |
| tomllib | 3.11 | tomli |
| typing.Self | 3.11 | typing-extensions |
| typing.TypedDict | 3.8 | typing-extensions |
| asyncio.TaskGroup | 3.11 | taskgroup |
| enum.StrEnum | 3.11 | strenum |

---

## Bug 修复

1. **警告信息泄露**: 修复 `--exclude-optional` 时仍显示可选包警告的问题
2. **测试覆盖**: 重写了全部测试用例，确保功能正确性验证

---

## 测试

- 测试用例总数: **263**
- 全部通过 ✅

测试覆盖：
- 输出格式验证（requirements.txt 各 section、JSON 结构）
- Python 版本检测（多种配置文件）
- 映射正确性（硬编码、命名空间）
- CLI 命令和参数
- 完整分析流程
- 边缘情况处理

---

## 升级指南

### 从 v0.1.0 升级

1. **参数变更**:
   ```bash
   # 旧版
   pyimport2pkg analyze . --include-optional

   # 新版 (默认包含可选包)
   pyimport2pkg analyze .

   # 新版 (排除可选包)
   pyimport2pkg analyze . --exclude-optional
   ```

2. **输出格式变化**:
   - requirements.txt 现在有多个 section
   - 包含中文注释说明

3. **API 变更**:
   ```python
   # Exporter 默认 include_optional=True
   exporter = Exporter()  # 默认包含可选包

   # 使用 detect_python_version
   from pyimport2pkg.filter import detect_python_version
   version = detect_python_version(Path("."))
   ```

---

## 下一版本计划 (v0.3.0)

- [ ] 支持 conda 环境检测
- [ ] 添加版本约束推断
- [ ] 支持 pyproject.toml 输出格式
- [ ] 交互式候选选择
- [ ] 更多 Flask/Django 扩展映射
