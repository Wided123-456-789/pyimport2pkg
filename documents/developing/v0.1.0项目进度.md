# PyImport2Pkg 项目进度文档

> 最后更新: 2025-12-05
> 版本: 0.1.0
> 状态: MVP 完成

---

## 一、项目概述

### 1.1 项目目标
开发一个 Python 工具，从代码的 import 语句**反向推断**需要安装的 pip 包名。解决 AI 辅助编码时代，开发者需要从 AI 生成的代码中手动查找包名的痛点。

### 1.2 核心问题
- 传统流程：先安装包，再写代码，最后 `pip freeze`
- AI 时代：AI 先生成代码，开发者需要从 `import xxx` 反推 `pip install yyy`
- 难点：`import cv2` → `pip install opencv-python`（名称不匹配）

### 1.3 设计决策
- **项目名称**: `pyimport2pkg`
- **映射数据源**: 完整方案（硬编码 + 本地数据库 + 在线构建）
- **冲突处理**: 自动选择最流行的包
- **Python 版本**: 3.10+

---

## 二、当前完成状态

### 2.1 开发阶段完成情况

| 阶段 | 内容 | 状态 |
|------|------|------|
| Phase 1 | 项目结构和基础设施 | ✅ 完成 |
| Phase 2 | Scanner 模块 | ✅ 完成 |
| Phase 3 | Parser 模块 | ✅ 完成 |
| Phase 4 | Filter 模块 | ✅ 完成 |
| Phase 5 | 硬编码映射表 | ✅ 完成 |
| Phase 6 | Mapper 模块 | ✅ 完成 |
| Phase 7 | Database 模块 | ✅ 完成 |
| Phase 8 | Resolver 和 Exporter | ✅ 完成 |
| Phase 9 | CLI 并集成测试 | ✅ 完成 |

### 2.2 测试状态
- **总测试数**: 161
- **通过**: 161
- **失败**: 0
- **覆盖模块**: 全部核心模块

---

## 三、项目结构

```
C:\Users\14044\Desktop\1\
├── pyproject.toml                    # 项目配置（setuptools）
├── 开发指导文档.md                    # 详细设计文档
├── 前因后果.md                        # 原始需求文档
├── 项目进度.md                        # 本文件
│
├── src/pyimport2pkg/                 # 源代码
│   ├── __init__.py                   # 包入口，版本信息
│   ├── cli.py                        # 命令行接口
│   ├── database.py                   # 数据库构建和查询
│   ├── exporter.py                   # 输出生成器
│   ├── filter.py                     # 标准库/本地模块过滤
│   ├── mapper.py                     # 模块→包名映射核心
│   ├── models.py                     # 数据模型定义
│   ├── parser.py                     # Import 语句解析
│   ├── resolver.py                   # 冲突解决
│   ├── scanner.py                    # 文件扫描
│   └── mappings/                     # 映射数据
│       ├── __init__.py
│       ├── hardcoded.py              # 硬编码映射表（100+包）
│       └── namespace.py              # 命名空间包映射
│
├── tests/                            # 测试文件
│   ├── __init__.py
│   ├── conftest.py                   # pytest 配置
│   ├── test_scanner.py               # 17 个测试
│   ├── test_parser.py                # 32 个测试
│   ├── test_filter.py                # 20 个测试
│   ├── test_mappings.py              # 22 个测试
│   ├── test_mapper.py                # 17 个测试
│   ├── test_database.py              # 13 个测试
│   ├── test_resolver.py              # 7 个测试
│   ├── test_exporter.py              # 16 个测试
│   ├── test_integration.py           # 17 个测试
│   └── fixtures/
│       └── sample_project/           # 测试用示例项目
│
└── .venv/                            # Python 虚拟环境
```

---

## 四、模块详细说明

### 4.1 Scanner (`scanner.py`)
**功能**: 扫描项目目录，收集 Python 文件

**关键特性**:
- 递归遍历目录
- 自动排除 `.venv`, `__pycache__`, `.git` 等
- 支持自定义排除规则
- 默认排除 `setup.py`

**主要 API**:
```python
from pyimport2pkg.scanner import scan_project

files = scan_project("./my_project", exclude_dirs={"tests"})
```

### 4.2 Parser (`parser.py`)
**功能**: 解析 Python 文件中的 import 语句

**支持的 import 类型**:
- `import xxx` - 标准导入
- `from xxx import yyy` - from 导入
- `from . import xxx` - 相对导入（标记为 relative）
- `importlib.import_module('xxx')` - 动态导入
- 条件导入（if 块内）- 标记为 optional
- try-except 导入 - 标记为 optional
- 函数内导入 - 记录上下文

**主要 API**:
```python
from pyimport2pkg.parser import parse_file

imports = parse_file("main.py")
for imp in imports:
    print(f"{imp.module_name} at line {imp.line_number}")
```

**ImportInfo 数据结构**:
```python
@dataclass
class ImportInfo:
    module_name: str           # 完整模块名 "google.cloud.storage"
    top_level: str             # 顶级模块 "google"
    sub_modules: list[str]     # 子模块 ["cloud", "storage"]
    file_path: Path | None
    line_number: int
    import_type: ImportType    # STANDARD | FROM | DYNAMIC
    context: ImportContext     # TOP_LEVEL | CONDITIONAL | TRY_EXCEPT | FUNCTION
    is_optional: bool
    is_relative: bool
    is_dynamic: bool
    warnings: list[str]
```

### 4.3 Filter (`filter.py`)
**功能**: 过滤标准库和本地模块

**过滤规则**:
1. 相对导入 → 直接丢弃
2. 标准库模块 → 丢弃（根据目标 Python 版本）
3. 本地项目模块 → 丢弃
4. 错误标记 → 丢弃

**Backports 支持**:
- `dataclasses` (< 3.7)
- `typing` (< 3.5)
- `tomllib` (< 3.11)
- `zoneinfo` (< 3.9)

**主要 API**:
```python
from pyimport2pkg.filter import Filter

f = Filter(project_root="./myproject", python_version=(3, 8))
third_party, filtered = f.filter_imports(imports)
```

### 4.4 Mappings (`mappings/`)
**功能**: 存储模块名到包名的映射数据

**hardcoded.py - 经典不匹配案例**:
```python
CLASSIC_MISMATCHES = {
    "cv2": ["opencv-python", "opencv-contrib-python", "opencv-python-headless"],
    "PIL": ["Pillow"],
    "sklearn": ["scikit-learn"],
    "yaml": ["PyYAML"],
    "bs4": ["beautifulsoup4"],
    # ... 100+ 映射
}

PTH_INJECTED_MODULES = {
    "win32api": "pywin32",
    "pythoncom": "pywin32",
    # ... PyWin32 全部模块
}
```

**namespace.py - 命名空间包**:
```python
NAMESPACE_PACKAGES = {
    "google": {
        "cloud": {
            "storage": "google-cloud-storage",
            "bigquery": "google-cloud-bigquery",
            # ...
        },
        "auth": "google-auth",
    },
    "azure": {
        "storage": {"blob": "azure-storage-blob"},
        "identity": "azure-identity",
        # ...
    },
}
```

### 4.5 Mapper (`mapper.py`)
**功能**: 核心映射逻辑，按优先级查询

**查询优先级**:
1. 命名空间包映射（如果有子模块）
2. 硬编码映射表
3. 命名空间包映射（顶级模块）
4. 数据库查询
5. 猜测（模块名 = 包名）

**主要 API**:
```python
from pyimport2pkg.mapper import Mapper

mapper = Mapper(database=db)  # database 可选
results = mapper.map_imports(third_party_imports)
```

### 4.6 Database (`database.py`)
**功能**: 构建和查询模块映射数据库

**数据来源**:
- PyPI Top 5000 包
- 从 wheel 文件提取 `top_level.txt`

**数据库 Schema**:
```sql
CREATE TABLE packages (
    package_name TEXT PRIMARY KEY,
    download_count INTEGER,
    last_updated TEXT
);

CREATE TABLE mappings (
    module_name TEXT,
    package_name TEXT,
    PRIMARY KEY (module_name, package_name)
);
```

**主要 API**:
```python
from pyimport2pkg.database import MappingDatabase, build_database

# 构建数据库
await build_database(max_packages=5000)

# 查询
db = MappingDatabase()
result = db.lookup("numpy")  # [(package_name, download_count), ...]
```

### 4.7 Resolver (`resolver.py`)
**功能**: 处理一对多冲突

**解决策略**:
- `MOST_POPULAR` - 选择下载量最高的（默认）
- `FIRST` - 选择第一个候选
- `ALL` - 保留所有候选

**平台特定推荐**:
```python
PLATFORM_SPECIFIC = {
    "tensorflow": {
        "darwin_arm64": "tensorflow-macos",
        "default": "tensorflow",
    },
}
```

### 4.8 Exporter (`exporter.py`)
**功能**: 生成输出文件

**支持格式**:
- `requirements.txt` - 带注释
- `JSON` - 结构化数据
- `simple` - 纯包名列表

**输出示例 (requirements.txt)**:
```
# Auto-generated by pyimport2pkg
# Generated at: 2025-12-05T10:19:37

# === Required packages ===
numpy
pandas
Pillow
scikit-learn

# === Optional packages ===
# ujson  # try_except in utils.py:42

# === Packages with multiple candidates ===
# cv2 -> Selected: opencv-python, Alternatives: opencv-contrib-python
```

### 4.9 CLI (`cli.py`)
**功能**: 命令行接口

**命令列表**:
```bash
# 分析项目
pyimport2pkg analyze ./my_project
pyimport2pkg analyze ./my_project -o requirements.txt
pyimport2pkg analyze ./my_project -f json
pyimport2pkg analyze ./my_project --exclude tests,docs
pyimport2pkg analyze ./my_project --python-version 3.8
pyimport2pkg analyze ./my_project --use-database

# 查询模块映射
pyimport2pkg query cv2
pyimport2pkg query google.cloud.storage

# 数据库管理
pyimport2pkg build-db --max-packages 5000
pyimport2pkg db-info
```

---

## 五、依赖关系

### 5.1 运行时依赖
```toml
[project]
dependencies = [
    "httpx>=0.25.0",  # 异步 HTTP 请求（数据库构建）
]
```

### 5.2 开发依赖
```toml
[project.optional-dependencies]
dev = [
    "pytest>=7.0.0",
    "pytest-asyncio>=0.21.0",
]
```

---

## 六、后续开发建议

### 6.1 短期改进
- [ ] 增加更多硬编码映射（持续维护）
- [ ] 改进 `from xxx import yyy` 的处理，尝试推断 `yyy` 是否为子模块
- [ ] 添加 `--quiet` 选项减少输出
- [ ] 支持 `.pyimport2pkg.toml` 配置文件

### 6.2 中期功能
- [ ] 预置数据库（打包进 wheel 中）
- [ ] 增量数据库更新
- [ ] IDE 插件（VS Code）
- [ ] pre-commit hook

### 6.3 长期规划
- [ ] 智能推断隐式依赖（如 `pandas.read_excel` → `openpyxl`）
- [ ] 版本兼容性检测
- [ ] 与 `pip-tools` 集成

---

## 七、运行测试

```bash
# 进入项目目录
cd C:\Users\14044\Desktop\1

# 激活虚拟环境
.venv\Scripts\activate

# 运行所有测试
pytest tests/ -v

# 运行特定模块测试
pytest tests/test_parser.py -v
pytest tests/test_mapper.py -v
pytest tests/test_integration.py -v

# 运行并查看覆盖率（需要安装 pytest-cov）
pytest tests/ --cov=pyimport2pkg --cov-report=html
```

---

## 八、关键代码位置速查

| 功能 | 文件 | 行号/函数 |
|------|------|-----------|
| 入口点 | `cli.py` | `main()` |
| 数据模型 | `models.py` | `ImportInfo`, `MappingResult` |
| 解析逻辑 | `parser.py` | `ImportVisitor` 类 |
| 标准库列表 | `filter.py` | `STDLIB_MODULES_FALLBACK` |
| 经典映射 | `mappings/hardcoded.py` | `CLASSIC_MISMATCHES` |
| 命名空间 | `mappings/namespace.py` | `NAMESPACE_PACKAGES` |
| 映射优先级 | `mapper.py` | `map_import()` 方法 |
| 数据库构建 | `database.py` | `DatabaseBuilder.build()` |

---

## 九、已知问题和限制

1. **`from xxx import yyy` 的限制**
   - 对于 `from google.cloud import storage`，只能识别到 `google.cloud`
   - 因为 `storage` 可能是子模块也可能是类/函数，静态分析无法区分
   - 建议使用完整导入：`import google.cloud.storage`

2. **动态导入限制**
   - `importlib.import_module(variable)` 无法静态解析
   - 只能解析字符串字面量参数

3. **隐式依赖**
   - 无法检测 `pandas.read_excel()` 需要 `openpyxl`
   - 这类情况需要用户手动处理

4. **版本兼容性**
   - 无法推断代码依赖的包版本
   - 默认安装最新版

---

## 十、环境信息

- **Python**: 3.13.9
- **操作系统**: Windows
- **虚拟环境**: `.venv`
- **包管理**: setuptools + pip

---

*文档生成时间: 2025-12-05*
